// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL") // pooler (runtime)
  directUrl = env("DIRECT_URL") // sem pooler (migrate)
}

/**
 * ===========================
 * CATEGORIES
 * ===========================
 */

model Category {
  id       String            @id @default(cuid())
  name     String
  slug     String            @unique
  parent   Category?         @relation("CategoryToCategory", fields: [parentId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  parentId String?
  children Category[]        @relation("CategoryToCategory")
  products ProductCategory[]

  @@index([parentId])
  @@index([slug])
  @@index([name])
}

model ProductCategory {
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  productId  String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  categoryId String

  @@id([productId, categoryId])
  @@index([categoryId])
  @@index([productId])
}

/**
 * ===========================
 * PRODUCTS
 * ===========================
 */

model ProductImage {
  id        String   @id @default(cuid())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  productId String
  url       String
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  @@index([productId])
  @@index([sortOrder])
}

model Product {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String
  price       Decimal  @db.Decimal(12, 2)
  imageUrl    String
  active      Boolean  @default(true)
  stock       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  sortOrder   Int      @default(0)

  packageSize String?
  pdfUrl      String?

  // Flags de visibilidade no site público
  visiblePrice       Boolean @default(false)
  visiblePackageSize Boolean @default(true)
  visiblePdf         Boolean @default(true)
  visibleImages      Boolean @default(true)
  visibleDescription Boolean @default(true)

  categories ProductCategory[]
  promotions Promotion[]
  orderItems OrderItem[]
  images     ProductImage[]

  @@index([active, sortOrder])
  @@index([createdAt])
  @@index([name])
}

model Promotion {
  id          String   @id @default(cuid())
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  productId   String
  title       String
  description String?
  percentOff  Int?
  priceOff    Decimal? @db.Decimal(12, 2)
  startsAt    DateTime
  endsAt      DateTime
  active      Boolean  @default(true)

  @@index([productId, active, startsAt, endsAt])
}

/**
 * ===========================
 * USERS
 * ===========================
 */

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  role      String   @default("ADMIN")
  createdAt DateTime @default(now())
}

/**
 * ===========================
 * CRM: CUSTOMER & ADDRESS
 * ===========================
 */

model Customer {

  id             String   @id @default(cuid())
  email          String   @unique
  phone          String?
  name           String
  company        String?
  marketingOptIn Boolean  @default(false)
  tags           String[] @default([])
  note           String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  addresses Address[]
  orders    OrderInquiry[] // pedidos vinculados

  @@index([name])
  @@index([phone])
  @@map("Contact") // mantém a tabela existente "Contact", mas no client vira prisma.customer
}

model Address {
  id         String    @id @default(cuid())
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  customerId String?
  line1      String
  line2      String?
  district   String?
  city       String
  state      String?
  postalCode String?
  country    String    @default("US")
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  ordersAsShipping OrderInquiry[] @relation("OrderInquiryToAddress")

  @@index([customerId])
  @@index([city])
  @@index([postalCode])
}

/**
 * ===========================
 * ORDERS
 * ===========================
 */

model OrderInquiry {

  id            String  @id @default(cuid())
  // snapshot do cliente no momento do pedido
  customerName  String
  customerEmail String
  customerPhone String?

  note      String?
  adminNote String?
  status    String   @default("RECEIVED") // RECEIVED|IN_PROGRESS|COMPLETED|REFUSED|CANCELLED
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items OrderItem[]

  // relação com Customer (CRM)
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  customerId String?

  // endereço na sacola
  address   Address? @relation("OrderInquiryToAddress", fields: [addressId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  addressId String?

  // recorrência opcional
  recurrence   String?
  intervalDays Int?

  // totais opcionais (como orçamento)
  subtotal Decimal @default(0) @db.Decimal(12, 2)
  total    Decimal @default(0) @db.Decimal(12, 2)
  currency String  @default("USD")

  @@index([status, createdAt])
  @@index([customerEmail])
  @@index([customerId])
  @@index([addressId])
  @@map("OrderInquiry")
}

model OrderItem {
  id        String       @id @default(cuid())
  order     OrderInquiry @relation(fields: [orderId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  orderId   String
  product   Product      @relation(fields: [productId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  productId String
  quantity  Int
  unitPrice Decimal      @db.Decimal(12, 2)

  @@index([orderId])
  @@index([productId])
}
